# Local Infrastructure Setup

This repository contains scripts and Docker Compose configurations to set up a local development infrastructure including Vault, Kafka, MySQL, and Redis.

## Prerequisites

*   Docker & Docker Compose
*   `jq` (JSON processor)

## Getting Started

### 1. Start Vault & Initialize Secrets

Vault is used to manage secrets for other services. It must be started and initialized first.

```bash
# Start Vault service
./vault-local/up.sh

# Initialize Vault and auto-generate secrets
./vault-local/init_vault.sh
```

This process will:
*   Start a Vault container.
*   Initialize and unseal Vault.
*   Save unseal keys and root token to `vault_keys.txt`.
*   Save unseal keys and root token to `vault_keys.txt`.
*   Enables `infras/` and `apps/` secret engines.
*   **Note**: This script **does not** generate secrets. Services will generate their own secrets upon startup.

### 3. Start Other Services

Once Vault is running and populated, you can start the other services. The startup scripts will automatically fetch credentials from Vault.

#### Kafka

```bash
./kafka-local/up.sh
```
*   **Auto-generates** `infras/kafka/sasl` credential if missing.
*   Generates JAAS configuration using secrets from Vault.
*   Starts a 3-node Kafka cluster with SASL authentication.

#### MySQL

```bash
./mysql-local/up.sh
```
*   **Auto-generates** `infras/mysql/root` credential if missing.
*   Starts a MySQL 8.0 instance with the generated root password.

#### Redis

```bash
./redis-local/up.sh
```
*   Fetches the Redis password from Vault.
*   Starts a 3-node Redis Cluster.

## Service Management

Each service directory (`kafka-local`, `mysql-local`, `redis-local`, `vault-local`) contains helper scripts:

*   `up.sh`: Start the service.
*   `down.sh`: Stop and remove the service containers.
*   `reset.sh`: Stop the service and remove data volumes (use with caution).

## Directory Structure

*   `vault-local/`: Vault configuration and initialization scripts.
*   `kafka-local/`: Kafka cluster configuration.
*   `mysql-local/`: MySQL configuration and initialization.
*   `redis-local/`: Redis Cluster configuration.
*   `volumes/`: Persistent data storage for containers (created automatically).
*   `vault_keys.txt`: Generated file containing Vault keys (do not commit this).
*   `vault_keys.txt`: Generated file containing Vault keys (do not commit this).

## User & ACL Management

A pipeline is provided to create users and ACLs for applications consuming the shared infrastructure.

### Scripts
*   `bin/setup_acl.sh <app_name> <infra_type>`: Provisions a user and generates a Vault Token.

### Vault Structure
*   `infras/<infra_type>/<app_name>`: Contains infrastructure credentials (e.g., DB password) generated by the script.
*   `apps/<app_name>`: Dedicated path for application-specific secrets. The app has read/list access to this path.

### Usage Example

To provision a MySQL user for `payment-service`:

```bash
./bin/setup_acl.sh payment-service mysql
```

**Output:**
```text
SERVICE: payment-service
INFRA:   mysql
SECRET:  infras/mysql/payment-service
TOKEN:   hvs.EXAMPLETOKEN...
```

The script generates a **Vault Token** that grants the application access to:
1.  Its infrastructure credentials at `infras/+/<app_name>/*`
2.  Its own secret path at `apps/<app_name>/*`

### Supported Infrastructure
*   `mysql`
*   `postgres`
*   `redis` (Updates ACL file; reload may be required)
*   `kafka` (Updates JAAS file; restart required)

### Utility Scripts
*   `vault-local/generate_token.sh <app_name>`: Generates a Vault token for an application, creating the necessary `app-<name>` policy to access `infras/+/<app_name>` and `apps/<app_name>`.

## Cross-Service Access Restrictions

Strict isolation rules are implemented to prevent services from accessing each other's data.

### Redis
*   **Keys**: Application users are restricted to keys matching `service_name:*`.
*   **Policy**: Implicit Deny for all other keys.

### Kafka
*   **Topics/Groups**: Application users are restricted to Topics and Consumer Groups matching `service_name-*`.
*   **Mechanism**: Uses KRaft `StandardAuthorizer`.
*   **Privileged Users**: `admin` and `kafka-X` (Broker Users).
*   **Controller Security**: The Controller listener is secured with SASL_PLAINTEXT and unique broker credentials.
